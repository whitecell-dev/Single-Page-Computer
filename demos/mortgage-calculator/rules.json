{
  "max_iterations": 20,
  "rules": [
    {
      "name": "calculate_combined_income",
      "priority": 1,
      "if": "applicant.annual_income > 0 && loan.processed !== true",
      "then": {
        "household.combined_income": "{{applicant.annual_income + (co_applicant.exists ? co_applicant.annual_income : 0)}}",
        "household.primary_income": "{{applicant.annual_income}}",
        "household.income_calculated": true
      }
    },
    {
      "name": "calculate_combined_debt",
      "priority": 2,
      "if": "household.income_calculated == true && household.debt_calculated !== true",
      "then": {
        "household.combined_debt": "{{applicant.existing_debt + (co_applicant.exists ? co_applicant.existing_debt : 0)}}",
        "household.debt_calculated": true
      }
    },
    {
      "name": "determine_credit_score",
      "priority": 3,
      "if": "household.income_calculated == true && household.credit_determined !== true",
      "then": {
        "household.credit_score": "{{co_applicant.exists ? Math.min(applicant.credit_score, co_applicant.credit_score) : applicant.credit_score}}",
        "household.credit_determined": true
      }
    },
    {
      "name": "validate_down_payment",
      "priority": 4,
      "if": "loan.down_payment > 0 && loan.down_payment_validated !== true",
      "then": {
        "loan.down_payment_percent": "{{(loan.down_payment / property.purchase_price) * 100}}",
        "loan.ltv_ratio": "{{((property.purchase_price - loan.down_payment) / property.purchase_price) * 100}}",
        "loan.down_payment_validated": true
      }
    },
    {
      "name": "determine_interest_rate",
      "priority": 5,
      "if": "household.credit_score > 0 && loan.interest_rate == 0 && loan.rate_determined !== true",
      "then": {
        "loan.base_rate": 6.75,
        "loan.credit_adjustment": "{{household.credit_score >= 760 ? -0.5 : household.credit_score >= 720 ? -0.25 : household.credit_score >= 680 ? 0 : household.credit_score >= 640 ? 0.25 : 0.75}}",
        "loan.ltv_adjustment": "{{loan.ltv_ratio > 80 ? 0.25 : 0}}",
        "loan.interest_rate": "{{loan.base_rate + loan.credit_adjustment + loan.ltv_adjustment}}",
        "loan.rate_determined": true
      }
    },
    {
      "name": "require_pmi_high_ltv",
      "priority": 6,
      "if": "loan.ltv_ratio > 80 && insurance.pmi_calculated !== true",
      "then": {
        "insurance.pmi_required": true,
        "insurance.pmi_rate": 0.5,
        "insurance.pmi_monthly": "{{(loan.requested_amount * (insurance.pmi_rate / 100)) / 12}}",
        "insurance.pmi_calculated": true
      }
    },
    {
      "name": "calculate_monthly_payment",
      "priority": 7,
      "if": "loan.interest_rate > 0 && loan.monthly_payment === undefined",
      "then": {
        "loan.monthly_rate": "{{loan.interest_rate / 100 / 12}}",
        "loan.num_payments": "{{loan.term_years * 12}}",
        "loan.monthly_principal_interest": "{{loan.requested_amount * (loan.monthly_rate * Math.pow(1 + loan.monthly_rate, loan.num_payments)) / (Math.pow(1 + loan.monthly_rate, loan.num_payments) - 1)}}",
        "loan.monthly_payment": "{{loan.monthly_principal_interest + (property.property_tax_annual / 12) + (insurance.homeowners_annual / 12) + (property.hoa_monthly || 0) + (insurance.pmi_monthly || 0)}}",
        "loan.payment_calculated": true
      }
    },
    {
      "name": "calculate_debt_to_income",
      "priority": 8,
      "if": "loan.payment_calculated == true && ratios.calculated !== true",
      "then": {
        "ratios.monthly_income": "{{household.combined_income / 12}}",
        "ratios.monthly_debt": "{{household.combined_debt / 12}}",
        "ratios.housing_ratio": "{{(loan.monthly_payment / ratios.monthly_income) * 100}}",
        "ratios.debt_to_income": "{{((ratios.monthly_debt + loan.monthly_payment) / ratios.monthly_income) * 100}}",
        "ratios.calculated": true
      }
    },
    {
      "name": "check_housing_ratio_limit",
      "priority": 9,
      "if": "ratios.housing_ratio > 0 && approval.housing_ratio_checked !== true",
      "then": {
        "approval.housing_ratio_status": "{{ratios.housing_ratio <= 28 ? 'pass' : ratios.housing_ratio <= 31 ? 'conditional' : 'fail'}}",
        "approval.housing_ratio_checked": true
      }
    },
    {
      "name": "check_debt_to_income_limit",
      "priority": 10,
      "if": "ratios.debt_to_income > 0 && approval.dti_checked !== true",
      "then": {
        "approval.dti_status": "{{ratios.debt_to_income <= 36 ? 'pass' : ratios.debt_to_income <= 43 ? 'conditional' : 'fail'}}",
        "approval.dti_checked": true
      }
    },
    {
      "name": "check_credit_requirements",
      "priority": 11,
      "if": "household.credit_score > 0 && approval.credit_checked !== true",
      "then": {
        "approval.credit_status": "{{household.credit_score >= 740 ? 'excellent' : household.credit_score >= 680 ? 'good' : household.credit_score >= 620 ? 'conditional' : 'insufficient'}}",
        "approval.credit_checked": true
      }
    },
    {
      "name": "determine_final_approval",
      "priority": 12,
      "if": "approval.housing_ratio_checked == true && approval.dti_checked == true && approval.credit_checked == true && approval.final_decision !== true",
      "then": {
        "approval.can_approve": "{{approval.housing_ratio_status != 'fail' && approval.dti_status != 'fail' && approval.credit_status != 'insufficient'}}",
        "approval.status": "{{approval.can_approve ? (approval.housing_ratio_status == 'conditional' || approval.dti_status == 'conditional' || approval.credit_status == 'conditional' ? 'conditional_approval' : 'approved') : 'denied'}}",
        "approval.final_decision": true
      }
    },
    {
      "name": "calculate_closing_costs",
      "priority": 13,
      "if": "approval.status == 'approved' && loan.closing_costs === undefined",
      "then": {
        "loan.origination_fee": "{{loan.requested_amount * 0.005}}",
        "loan.appraisal_fee": 600,
        "loan.title_insurance": "{{property.purchase_price * 0.003}}",
        "loan.closing_costs": "{{loan.origination_fee + loan.appraisal_fee + loan.title_insurance + 2500}}",
        "loan.total_cash_needed": "{{loan.down_payment + loan.closing_costs}}"
      }
    },
    {
      "name": "finalize_loan_processing",
      "priority": 14,
      "if": "approval.final_decision == true && loan.processed !== true",
      "then": {
        "loan.processed": true,
        "loan.application_date": "{{now()}}",
        "loan.reference_number": "{{uuid()}}",
        "loan.next_step": "{{approval.status == 'approved' ? 'Schedule appraisal and title search' : approval.status == 'conditional_approval' ? 'Submit additional documentation' : 'Consider alternative financing options'}}"
      }
    }
  ]
}

