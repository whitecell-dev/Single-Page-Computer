{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "AXIS/KERN Mortgage Rules Schema",
  "description": "Schema for mortgage underwriting rules configuration",

  "mortgageRules": {
    "type": "object",
    "required": ["max_iterations", "rules"],
    "properties": {
      "max_iterations": {
        "type": "integer",
        "minimum": 1,
        "maximum": 50,
        "default": 20
      },
      "rules": {
        "type": "array",
        "items": {
          "type": "object",
          "required": ["name", "priority", "if", "then"],
          "properties": {
            "name": {
              "type": "string",
              "pattern": "^[a-z][a-z0-9_]*$",
              "description": "Unique rule identifier"
            },
            "priority": {
              "type": "integer",
              "minimum": 1,
              "maximum": 1000,
              "description": "Execution priority (lower = earlier)"
            },
            "if": {
              "type": "string",
              "maxLength": 500,
              "description": "Condition expression using safe eval"
            },
            "then": {
              "type": "object",
              "additionalProperties": {
                "type": "string",
                "maxLength": 400,
                "description": "Field path to template expression mapping"
              }
            },
            "description": {
              "type": "string",
              "description": "Human-readable rule description"
            },
            "category": {
              "type": "string",
              "enum": ["income", "debt", "credit", "property", "ratios", "approval", "closing"],
              "description": "Rule category for organization"
            }
          }
        }
      }
    }
  },

  "mortgageState": {
    "type": "object",
    "required": ["applicant", "property", "loan"],
    "properties": {
      "applicant": {
        "type": "object",
        "required": ["name", "annual_income", "credit_score"],
        "properties": {
          "name": { "type": "string" },
          "age": { "type": "integer", "minimum": 18, "maximum": 100 },
          "employment_status": {
            "type": "string",
            "enum": ["full_time", "part_time", "contract", "self_employed", "unemployed"]
          },
          "annual_income": { "type": "number", "minimum": 0 },
          "employment_years": { "type": "number", "minimum": 0 },
          "credit_score": { "type": "integer", "minimum": 300, "maximum": 850 },
          "existing_debt": { "type": "number", "minimum": 0 },
          "savings": { "type": "number", "minimum": 0 },
          "first_time_buyer": { "type": "boolean" }
        }
      },
      "co_applicant": {
        "type": "object",
        "properties": {
          "exists": { "type": "boolean" },
          "annual_income": { "type": "number", "minimum": 0 },
          "employment_years": { "type": "number", "minimum": 0 },
          "credit_score": { "type": "integer", "minimum": 300, "maximum": 850 },
          "existing_debt": { "type": "number", "minimum": 0 }
        }
      },
      "property": {
        "type": "object",
        "required": ["purchase_price", "property_type"],
        "properties": {
          "purchase_price": { "type": "number", "minimum": 0 },
          "property_type": {
            "type": "string",
            "enum": ["single_family", "condo", "townhouse", "multi_family"]
          },
          "location_state": { "type": "string", "pattern": "^[A-Z]{2}$" },
          "appraised_value": { "type": "number", "minimum": 0 },
          "property_tax_annual": { "type": "number", "minimum": 0 },
          "hoa_monthly": { "type": "number", "minimum": 0 }
        }
      },
      "loan": {
        "type": "object",
        "required": ["requested_amount", "down_payment", "term_years", "type"],
        "properties": {
          "requested_amount": { "type": "number", "minimum": 0 },
          "down_payment": { "type": "number", "minimum": 0 },
          "term_years": {
            "type": "integer",
            "enum": [10, 15, 20, 30]
          },
          "type": {
            "type": "string",
            "enum": ["conventional", "fha", "va", "usda"]
          },
          "interest_rate": { "type": "number", "minimum": 0, "maximum": 100 },
          "processed": { "type": "boolean", "default": false },
          "monthly_payment": { "type": "number", "minimum": 0 },
          "ltv_ratio": { "type": "number", "minimum": 0, "maximum": 150 },
          "closing_costs": { "type": "number", "minimum": 0 },
          "total_cash_needed": { "type": "number", "minimum": 0 }
        }
      },
      "insurance": {
        "type": "object",
        "properties": {
          "homeowners_annual": { "type": "number", "minimum": 0 },
          "pmi_required": { "type": "boolean" },
          "pmi_monthly": { "type": "number", "minimum": 0 }
        }
      },
      "household": {
        "type": "object",
        "properties": {
          "combined_income": { "type": "number", "minimum": 0 },
          "primary_income": { "type": "number", "minimum": 0 },
          "income_calculated": { "type": "boolean" },
          "combined_debt": { "type": "number", "minimum": 0 },
          "debt_calculated": { "type": "boolean" },
          "credit_score": { "type": "integer", "minimum": 300, "maximum": 850 },
          "credit_determined": { "type": "boolean" }
        }
      },
      "ratios": {
        "type": "object",
        "properties": {
          "calculated": { "type": "boolean" },
          "monthly_income": { "type": "number", "minimum": 0 },
          "monthly_debt": { "type": "number", "minimum": 0 },
          "housing_ratio": { "type": "number", "minimum": 0, "maximum": 100 },
          "debt_to_income": { "type": "number", "minimum": 0, "maximum": 100 }
        }
      },
      "approval": {
        "type": "object",
        "properties": {
          "status": {
            "type": "string",
            "enum": ["pending", "approved", "conditional_approval", "denied"]
          },
          "conditions": {
            "type": "array",
            "items": { "type": "string" }
          },
          "final_decision": { "type": "boolean" },
          "can_approve": { "type": "boolean" },
          "housing_ratio_status": {
            "type": "string",
            "enum": ["pass", "conditional", "fail"]
          },
          "dti_status": {
            "type": "string", 
            "enum": ["pass", "conditional", "fail"]
          },
          "credit_status": {
            "type": "string",
            "enum": ["excellent", "good", "conditional", "insufficient"]
          },
          "housing_ratio_checked": { "type": "boolean" },
          "dti_checked": { "type": "boolean" },
          "credit_checked": { "type": "boolean" }
        }
      }
    }
  },

  "executionResult": {
    "type": "object",
    "required": ["input", "output", "iterations", "audit"],
    "properties": {
      "input": { "$ref": "#/mortgageState" },
      "output": { "$ref": "#/mortgageState" },
      "iterations": { "type": "integer", "minimum": 1 },
      "audit": {
        "type": "array",
        "items": {
          "type": "object",
          "required": ["timestamp", "level", "message"],
          "properties": {
            "timestamp": { "type": "string", "format": "date-time" },
            "level": {
              "type": "string",
              "enum": ["info", "warn", "error"]
            },
            "message": { "type": "string" }
          }
        }
      },
      "conflicts": {
        "type": "array",
        "items": {
          "type": "object",
          "required": ["field", "previousRule", "currentRule", "iteration"],
          "properties": {
            "field": { "type": "string" },
            "previousRule": { "type": "string" },
            "currentRule": { "type": "string" },
            "resolution": { "type": "string" },
            "iteration": { "type": "integer", "minimum": 1 }
          }
        }
      },
      "rulesApplied": {
        "type": "array",
        "items": { "type": "string" }
      },
      "primitiveStats": {
        "type": "object",
        "properties": {
          "EXPRESSION_EVALUATOR": { "type": "integer", "minimum": 0 },
          "CONTEXT_SANITIZER": { "type": "integer", "minimum": 0 },
          "CONDITION_EVALUATOR": { "type": "integer", "minimum": 0 },
          "TEMPLATE_RESOLVER": { "type": "integer", "minimum": 0 },
          "STATE_MUTATOR": { "type": "integer", "minimum": 0 },
          "OBJECT_FLATTENER": { "type": "integer", "minimum": 0 },
          "RULE_APPLICATOR": { "type": "integer", "minimum": 0 },
          "ITERATION_MANAGER": { "type": "integer", "minimum": 0 }
        }
      }
    }
  }
}
