<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>React User Status SPC - AXIS</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        .subtitle {
            color: #718096;
            font-size: 1.1em;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        .section {
            background: #f8fafc;
            border-radius: 12px;
            padding: 25px;
            border-left: 4px solid #667eea;
        }
        .section h3 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.3em;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 8px;
        }
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .button-group {
            text-align: center;
            margin: 30px 0;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            margin: 0 10px;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        .results {
            background: #f0f8ff;
            border: 2px solid #3182ce;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
        }
        .results h3 {
            color: #2d3748;
            margin-bottom: 20px;
        }
        .data-display {
            background: #1a202c;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        .audit-trail {
            background: #f0fff4;
            border: 2px solid #38a169;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        .audit-entry {
            padding: 8px 12px;
            margin: 5px 0;
            background: #e6fffa;
            border-radius: 6px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 13px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #e2e8f0;
        }
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
        .stat-label {
            color: #718096;
            font-size: 0.9em;
            margin-top: 5px;
        }
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-active {
            background: #c6f6d5;
            color: #276749;
        }
        .status-pending {
            background: #feebc8;
            color: #c05621;
        }
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    // --- AxisRulesEngine (same as your version above) ---
    class AxisRulesEngine {
      constructor() {
        this.auditTrail = [];
        this.conflictLog = [];
        this.currentIteration = 0;
      }
      apply(inputData, rulesConfig) {
        this.auditTrail = [];
        this.conflictLog = [];
        this.currentIteration = 0;
        let currentState = JSON.parse(JSON.stringify(inputData));
        let iteration = 0;
        let changed = true;
        const maxIterations = rulesConfig.max_iterations || 10;
        const sortedRules = [...(rulesConfig.rules || [])].sort(
          (a, b) => (a.priority || 999) - (b.priority || 999)
        );
        while (changed && iteration < maxIterations) {
          changed = false;
          iteration++;
          this.currentIteration = iteration;
          const iterationChanges = new Map();
          for (let rule of sortedRules) {
            const prevState = JSON.stringify(currentState);
            if (this.evaluateCondition(rule.if, currentState)) {
              this.log(`Applied: ${rule.name}`);
              if (rule.then) {
                const result = this.applyTransformationsWithTracking(
                  currentState, rule.then, rule.name, iterationChanges
                );
                currentState = result.newState;
                if (prevState !== JSON.stringify(currentState)) {
                  changed = true;
                }
              }
            }
          }
        }
        return {
          input: inputData,
          output: currentState,
          iterations: iteration,
          audit: this.auditTrail,
          conflicts: this.conflictLog,
          rulesApplied: this.getRulesApplied()
        };
      }
      applyTransformationsWithTracking(state, transformations, ruleName, iterationChanges) {
        const newState = JSON.parse(JSON.stringify(state));
        for (const [path, value] of Object.entries(transformations)) {
          const resolvedValue = this.resolveValue(value, newState);
          if (iterationChanges.has(path)) {
            const previousRule = iterationChanges.get(path);
            this.conflictLog.push({ field: path, previousRule, currentRule: ruleName, iteration: this.currentIteration });
          }
          iterationChanges.set(path, ruleName);
          this.setNestedPath(newState, path, resolvedValue);
        }
        return { newState };
      }
      evaluateCondition(condition, context) {
        if (!condition) return true;
        try {
          const safeContext = this.createSafeContext(context);
          const func = new Function(...Object.keys(safeContext), `return ${condition}`);
          return Boolean(func(...Object.values(safeContext)));
        } catch {
          return false;
        }
      }
      resolveValue(template, context) {
        if (typeof template !== 'string') return template;
        if (template.includes('{{') && template.includes('}}')) {
          const expression = template.replace(/\{\{(.*?)\}\}/g, '$1').trim();
          try {
            if (expression === 'now()') return new Date().toISOString();
            if (expression === 'uuid()') return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
              const r = (Math.random() * 16) | 0;
              const v = c === 'x' ? r : (r & 0x3) | 0x8;
              return v.toString(16);
            });
            const safeContext = this.createSafeContext(context);
            const func = new Function(...Object.keys(safeContext), `return ${expression}`);
            return func(...Object.values(safeContext));
          } catch { return template; }
        }
        return template;
      }
      createSafeContext(context) {
        const flattened = this.flattenObject(context);
        return { ...flattened, ...context, Math, Date, parseInt, parseFloat, String, Number, Boolean, Array, JSON };
      }
      flattenObject(obj, prefix = '') {
        const flattened = {};
        for (const key in obj) {
          if (obj.hasOwnProperty(key)) {
            const newKey = prefix ? `${prefix}.${key}` : key;
            if (typeof obj[key] === 'object' && obj[key] !== null && !Array.isArray(obj[key])) {
              Object.assign(flattened, this.flattenObject(obj[key], newKey));
            } else {
              flattened[newKey.replace(/\./g, '_')] = obj[key];
            }
          }
        }
        return flattened;
      }
      setNestedPath(obj, path, value) {
        const keys = path.split('.');
        let current = obj;
        for (let i = 0; i < keys.length - 1; i++) {
          if (!current[keys[i]] || typeof current[keys[i]] !== 'object') {
            current[keys[i]] = {};
          }
          current = current[keys[i]];
        }
        current[keys[keys.length - 1]] = value;
      }
      log(message, level = 'info') {
        this.auditTrail.push({ timestamp: new Date().toISOString(), level, message });
      }
      getRulesApplied() {
        return this.auditTrail.filter(e => e.message.startsWith('Applied:')).map(e => e.message.replace('Applied: ', ''));
      }
    }

    // --- React Components ---
    const { useState } = React;

    function UserStatusSPC() {
      const defaultUserData = {
        user: { age: 25, role: "admin", email_verified: true, account_created: "2024-01-15" },
        stats: { login_count: 45, last_login: "2024-02-01" }
      };
      const defaultRules = {
        max_iterations: 5,
        rules: [
          { name: "activate_verified_users", priority: 1, if: "user.age >= 18 && user.email_verified == true",
            then: { "user.status": "active", "user.activated_date": "{{now()}}" } },
          { name: "award_admin_privileges", priority: 2, if: "user.role == 'admin' && user.status == 'active'",
            then: { "user.permissions": ["read","write","admin"], "user.admin_level": 1 } },
          { name: "calculate_engagement", priority: 3, if: "stats.login_count > 0",
            then: { "stats.engagement_score": "{{Math.floor(stats.login_count / 10)}}" } }
        ]
      };

      const [userData, setUserData] = useState(defaultUserData);
      const [rules, setRules] = useState(defaultRules);
      const [engineResult, setEngineResult] = useState(null);
      const [showAudit, setShowAudit] = useState(false);
      const [showRulesEditor, setShowRulesEditor] = useState(false);
      const [customRules, setCustomRules] = useState(JSON.stringify(defaultRules, null, 2));

      const engine = new AxisRulesEngine();

      const applyRules = () => {
        const result = engine.apply(userData, rules);
        setEngineResult(result);
        setUserData(result.output);
      };

      const resetToDefaults = () => {
        setUserData(defaultUserData);
        setRules(defaultRules);
        setCustomRules(JSON.stringify(defaultRules, null, 2));
        setEngineResult(null);
      };

      const loadDemoRuleset = (type) => {
        if (type === 'ecommerce') {
          const demo = {
            max_iterations: 5,
            rules: [
              { name: "apply_discount", priority: 1, if: "user.role == 'customer' && stats.login_count > 10",
                then: { "user.discount": 0.1 } }
            ]
          };
          setRules(demo);
          setCustomRules(JSON.stringify(demo, null, 2));
        } else if (type === 'content') {
          const demo = {
            max_iterations: 5,
            rules: [
              { name: "grant_moderator", priority: 1, if: "user.role == 'user' && stats.login_count > 100",
                then: { "user.role": "moderator" } }
            ]
          };
          setRules(demo);
          setCustomRules(JSON.stringify(demo, null, 2));
        }
      };

      const loadNewRules = () => {
        try {
          const parsed = JSON.parse(customRules);
          setRules(parsed);
          applyRules();
        } catch {
          alert("Invalid JSON in custom rules!");
        }
      };

      const updateUser = (field, value) => {
        setUserData(prev => ({ ...prev, user: { ...prev.user, [field]: value } }));
      };
      const updateStats = (field, value) => {
        setUserData(prev => ({ ...prev, stats: { ...prev.stats, [field]: parseInt(value) || 0 } }));
      };

      return (
        <div className="container">
          <div className="header">
            <h1>React User Status SPC</h1>
            <p className="subtitle">Zero-install SPC with React UI + AXIS Rules Engine</p>
          </div>

          <div className="grid">
            <div className="section">
              <h3>User Input Form</h3>
              <div className="form-group">
                <label>Age</label>
                <input type="number" value={userData.user.age}
                       onChange={(e) => updateUser('age', parseInt(e.target.value))}/>
              </div>
              <div className="form-group">
                <label>Role</label>
                <select value={userData.user.role}
                        onChange={(e) => updateUser('role', e.target.value)}>
                  <option value="user">User</option>
                  <option value="admin">Admin</option>
                  <option value="moderator">Moderator</option>
                </select>
              </div>
              <div className="form-group">
                <label>Email Verified</label>
                <select value={userData.user.email_verified}
                        onChange={(e) => updateUser('email_verified', e.target.value === 'true')}>
                  <option value="true">Yes</option>
                  <option value="false">No</option>
                </select>
              </div>
              <div className="form-group">
                <label>Login Count</label>
                <input type="number" value={userData.stats.login_count}
                       onChange={(e) => updateStats('login_count', e.target.value)}/>
              </div>
            </div>

            <div className="section">
              <h3>Live State Data</h3>
              <div className="data-display">{JSON.stringify(userData, null, 2)}</div>
            </div>
          </div>

          <div className="button-group">
            <button onClick={applyRules}>Apply Rules Engine</button>
            <button onClick={() => setShowAudit(!showAudit)}>{showAudit ? 'Hide Audit' : 'Show Audit'}</button>
            <button onClick={() => setShowRulesEditor(!showRulesEditor)}>
              {showRulesEditor ? 'Hide Rules Editor' : 'Hot-Swap Rules'}
            </button>
            <button onClick={resetToDefaults} style={{background: '#e53e3e'}}>Reset All Data</button>
          </div>

          {showRulesEditor && (
            <div className="section" style={{background:'#fffbf0',borderColor:'#f6ad55'}}>
              <h3>ðŸ”„ Hot-Swap Rules Engine</h3>
              <div>
                <h4>Quick Load Demo Rulesets:</h4>
                <button onClick={() => loadDemoRuleset('ecommerce')}>E-commerce</button>
                <button onClick={() => loadDemoRuleset('content')}>Content</button>
              </div>
              <textarea rows="12" value={customRules}
                        onChange={(e)=>setCustomRules(e.target.value)}
                        style={{width:'100%',fontFamily:'monospace'}}/>
              <button onClick={loadNewRules}>ðŸš€ Load & Apply</button>
            </div>
          )}

          {engineResult && (
            <div className="results">
              <h3>Engine Results</h3>
              <div className="stats-grid">
                <div className="stat-card"><div className="stat-value">{engineResult.iterations}</div><div className="stat-label">Iterations</div></div>
                <div className="stat-card"><div className="stat-value">{engineResult.rulesApplied.length}</div><div className="stat-label">Rules Applied</div></div>
                <div className="stat-card"><div className="stat-value">{engineResult.conflicts.length}</div><div className="stat-label">Conflicts</div></div>
                <div className="stat-card">
                  <div className="stat-value">
                    <span className={`status-badge ${userData.user.status === 'active' ? 'status-active':'status-pending'}`}>
                      {userData.user.status || 'pending'}
                    </span>
                  </div>
                  <div className="stat-label">User Status</div>
                </div>
              </div>
            </div>
          )}

          {showAudit && engineResult && (
            <div className="audit-trail">
              <h3>Execution Audit Trail</h3>
              {engineResult.audit.map((entry, i) => (
                <div key={i} className="audit-entry">
                  [{entry.timestamp.split('T')[1].split('.')[0]}] {entry.message}
                </div>
              ))}
            </div>
          )}
        </div>
      );
    }

    ReactDOM.render(<UserStatusSPC />, document.getElementById('root'));
  </script>
</body>
</html>
